# ExamRizz Arena v6.2 — Session Changelog

**Date:** 29 December 2024  
**Status:** FUNCTIONAL MVP  
**Data:** 28,520 UK university courses  
**Stack:** Next.js 14 + Supabase + Tailwind CSS

---

## CHANGES IN v6.2

### 1. Diversity Constraint (NEW)

**Problem:** Top 20 results could all be from the same university if disposition match was similar across their courses.

**Solution:** Added `applyDiversityConstraint()` function that limits max 3 courses per university in results.

**Implementation:**
- Iterates through sorted results
- Tracks count per university
- Skips if university already has 3 courses
- Fills remaining slots with next-best from other universities

**Files changed:** `matching.ts`

**API change:** `rankCourses()` and `rankCoursesAsync()` now accept optional `maxPerUniversity` parameter (default: 3)

---

### 2. Quality Weighting (NEW)

**Problem:** Bedfordshire and Oxford scored identically if disposition match was the same.

**Solution:** Added quality bonus based on institutional and outcome data.

| Factor | Bonus | Threshold |
|--------|-------|-----------|
| Russell Group | +5 points | Boolean flag |
| NSS Overall | +3 points | ≥80% |
| Employment Rate | +2 points | ≥90% |
| Median Salary (3yr) | +2 points | ≥£30,000 |

**Maximum quality bonus:** +12 points

**Files changed:** `matching.ts`, `types.ts`

---

### 3. Per-Course Disposition Modifiers (NEW)

**Problem:** All Computer Science courses had identical disposition demands regardless of teaching style.

**Solution:** `getEffectiveDemand()` function adjusts base CAH demands using per-course HESA data.

| HESA Field | Affects | Logic |
|------------|---------|-------|
| `assessment_exam_pct` | RETRIEVAL | +3 per 10% above 50% |
| `assessment_practical_pct` | PRECISION | +2 per 10% practical |
| `continuation_rate` | TOLERANCE | +5 if 10% below 85% threshold |
| `scheduled_hours` | STRUCTURE | +3 per 5 hours above 15/week |
| `nss_feedback` | RECEPTIVITY | +0.3 per point above 75 |
| `assessment_coursework_pct` | SOCIAL | +2 per 10% above 30% |

**Files changed:** `matching.ts`

---

### 4. Updated Types (NEW)

**Added to Course interface:**
- Full HESA fields (ukprn, kis_course_id, cah_code, region, etc.)
- Outcome data (nss_overall, employment_rate, median_salary_3yr, etc.)
- Teaching structure (assessment_exam_pct, scheduled_hours, etc.)
- Course variants (sandwich, year_abroad, foundation)

**Added new interfaces:**
- `UserPreferences` — For filtering and boosting courses

**Added new types:**
- `CourseVariant` — 'STANDARD' | 'SANDWICH' | 'YEAR_ABROAD' | 'JOINT_HONOURS'

**Added new constants:**
- `QUALITY_THRESHOLDS` — Threshold values for quality bonuses
- `QUALITY_BONUSES` — Point values for each quality factor

**Added to MatchResult:**
- `quality_bonus: number` — Track quality bonus separately

**Files changed:** `types.ts`

---

## CURRENT STATE

### What's Working
- ✅ Full assessment flow (vibe → cognitive → behavioural → results)
- ✅ Course matching with CAH-based dispositions
- ✅ Per-course disposition modifiers from HESA data
- ✅ Quality weighting (Russell Group, NSS, employment, salary)
- ✅ Diversity constraint (max 3 per university)
- ✅ Identity system (14 familiars, 4 guilds)
- ✅ 28,520 real courses with authentic HESA data

### Known Issues
- ⚠️ Results page flash error (React hydration issue)
- ⚠️ Course variants (sandwich, year abroad) shown as separate results
- ⚠️ No user preferences UI yet

---

## NEXT PRIORITIES

### Priority 1: Course Variant Grouping
- Flag variant types on courses (sandwich, year_abroad, joint_honours)
- Group by "base course" — treat variants as children
- Show main course in results with expandable variants

### Priority 2: User Preferences System
- Data model for preferences (vibe tags, target unis, filters)
- UI for editing preferences post-results
- Re-ranking on preference change

### Priority 3: Entry Requirements
- UCAS points / A-level grade filtering
- Hard filter (exclude courses user can't apply to)
- Soft boost (prefer courses within reach)

---

## FILE CHANGES SUMMARY

| File | Status | Changes |
|------|--------|---------|
| `types.ts` | UPDATED | Added HESA fields, UserPreferences, quality constants |
| `matching.ts` | UPDATED | Added diversity, quality, per-course modifiers |

---

## HOW TO APPLY CHANGES

1. Replace `src/lib/types.ts` with updated version
2. Replace `src/lib/matching.ts` with updated version
3. No database changes required (uses existing HESA columns)
4. Test with `npm run dev`

---

## CONTEXT FOR NEXT SESSION

### Key Files
- `types.ts` — All TypeScript interfaces
- `matching.ts` — Course matching algorithm (4-layer + quality + diversity)
- `scoring.ts` — Disposition scoring from question responses
- `identity.ts` — Familiar and guild assignment

### Key Commands
```bash
cd /Users/bohee/examrizz-arena
npm run dev
```

### Key SQL Queries
```sql
-- Check quality bonus distribution
SELECT 
  russell_group,
  COUNT(*),
  AVG(nss_overall) as avg_nss,
  AVG(employment_rate) as avg_employment
FROM bo_v1_courses 
GROUP BY russell_group;

-- Check per-course modifiers are working
SELECT 
  course_name,
  assessment_exam_pct,
  assessment_practical_pct,
  continuation_rate,
  scheduled_hours
FROM bo_v1_courses 
WHERE assessment_exam_pct IS NOT NULL
LIMIT 20;
```

### Estimated Differentiation
- **Before v6.2:** ~5,000 distinguishable course clusters
- **After v6.2:** ~15,000 distinguishable course clusters (3× improvement)

---

## FUTURE ROADMAP

### Near-term (Next 2-3 sessions)
- Course variant grouping
- User preferences UI
- Entry requirements filtering
- Fix results page flash error

### Medium-term
- Per-university disposition modifiers (Oxford CS ≠ generic CS)
- Accreditation signals (BCS, GMC, etc.)
- Course description parsing for keywords

### Long-term (ML approaches)
- Collaborative filtering ("students like you chose...")
- Embedding similarity for semantic course matching
- Outcome prediction ("your predicted satisfaction at X")

---

**Document Version:** 6.2  
**Last Updated:** 29 December 2024  
**Previous Version:** 6.1
